<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Change Maker by IPI</title>
  <!-- [CSS remains the same] -->
</head>
<body>
  <!-- [HTML structure remains the same] -->

  <script>
    const repoMap = {
      // [Your repo URLs remain the same]
    };
    
    let initialized = {};
    let accessToken = null;
    const REGION = 'mypurecloud.ie';
    const CLIENT_ID = '4652c8b5-9117-43c6-8e54-77eeb38aebb8';
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // 1. First check for token in URL hash
    function checkAuth() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      accessToken = params.get('access_token');
      
      if (accessToken) {
        // Store token and clean URL
        sessionStorage.setItem('purecloud_token', accessToken);
        window.history.replaceState({}, document.title, REDIRECT_URI);
        validateToken();
      } else {
        // Check session storage
        accessToken = sessionStorage.getItem('purecloud_token');
        if (accessToken) {
          validateToken();
        } else {
          // Initiate auth flow
          startAuthFlow();
        }
      }
    }

    // 2. Start authentication flow
    function startAuthFlow() {
      const authUrl = `https://login.${REGION}/oauth/authorize?` +
        `client_id=${CLIENT_ID}&` +
        `response_type=token&` +
        `redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
      
      window.location.href = authUrl;
    }

    // 3. Validate the token
    async function validateToken() {
      try {
        const response = await fetch(`https://api.${REGION}/api/v2/users/me`, {
          headers: { "Authorization": `Bearer ${accessToken}` }
        });
        
        if (!response.ok) {
          throw new Error("Invalid token");
        }
        
        // Token is valid - initialize app
        initializeApp();
      } catch (error) {
        console.error("Authentication failed:", error);
        // Clear invalid token and retry
        sessionStorage.removeItem('purecloud_token');
        startAuthFlow();
      }
    }

    // 4. Initialize the application
    function initializeApp() {
      setupTabs();
      openTab({preventDefault: () => {}}, 'wfmManagement');
    }

    // [Rest of your code remains the same...]

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>
