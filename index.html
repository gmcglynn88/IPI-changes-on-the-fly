<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Change Maker by IPI</title>
  <link href="https://fonts.googleapis.com/css2?family=Aptos:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* [Previous CSS styles remain exactly the same] */
  </style>
</head>
<body>
  <!-- [Previous HTML structure remains exactly the same] -->

  <script>
    const repoMap = {
      wfmManagement: 'https://raw.githubusercontent.com/gmcglynn88/MU-Search---Changemaker/main/index.html',
      externalWork: 'https://raw.githubusercontent.com/gmcglynn88/External-Work-Creation---Changemaker/main/index.html',
      activityCode: 'https://raw.githubusercontent.com/gmcglynn88/Activity-code-management---changemaker/main/index.html',
      bulkSkills: 'https://raw.githubusercontent.com/gmcglynn88/Bulk-Skills-Update---Changemaker/main/index.html',
      bulkQueues: 'https://raw.githubusercontent.com/gmcglynn88/Bulk-Queue-Updater---Changemaker/main/index.html',
      workTeamManagement: 'https://raw.githubusercontent.com/gmcglynn88/Workteam-Management---Chnagemaker/main/index.html',
      intradayPlan: 'https://raw.githubusercontent.com/gmcglynn88/Intraday-Plan---Changemaker/main/index.html'
    };
    
    let initialized = {};
    let accessToken = null;
    const REGION = 'mypurecloud.ie';
    const CLIENT_ID = '4652c8b5-9117-43c6-8e54-77eeb38aebb8';
    const REDIRECT_URI = window.location.href.split('?')[0];

    // Initialize auth when page loads
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      accessToken = params.get('access_token');
      
      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        validateToken();
      } else {
        accessToken = sessionStorage.getItem('purecloud_token');
        if (accessToken) {
          validateToken();
        } else {
          window.location.href = `https://login.${REGION}/oauth/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
        }
      }
      
      // Set up tab navigation as before
      setupTabs();
    });

    async function validateToken() {
      try {
        const response = await fetch(`https://api.${REGION}/api/v2/users/me`, {
          headers: { "Authorization": `Bearer ${accessToken}` }
        });
        if (!response.ok) throw new Error("Token invalid");
        loadRepo('wfmManagement');
      } catch (error) {
        sessionStorage.removeItem('purecloud_token');
        window.location.href = `https://login.${REGION}/oauth/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
      }
    }

    function setupTabs() {
      // [Previous tab setup code remains the same]
    }

    async function loadRepo(name) {
      const url = repoMap[name];
      const tabContent = document.querySelector(`#${name} .app-window`);
      
      try {
        // Show loading state
        tabContent.innerHTML = `
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading ${name.replace(/([A-Z])/g, ' $1').trim()}...</p>
          </div>
        `;
        
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Failed to fetch ${name} module (HTTP ${res.status})`);
        
        let content = await res.text();
        
        // Inject the access token into the module's code
        content = content.replace(/let token = null;/, `let token = '${accessToken}';`);
        content = content.replace(/const REGION = '[^']*';/, `const REGION = '${REGION}';`);
        
        // Create a secure container for the module
        const container = document.createElement('div');
        container.innerHTML = content;
        
        // Remove any existing scripts (we'll handle them specially)
        const scripts = container.querySelectorAll('script');
        scripts.forEach(script => script.remove());
        
        // Insert the sanitized HTML
        tabContent.innerHTML = container.innerHTML;
        
        // Now handle the scripts
        scripts.forEach(oldScript => {
          if (oldScript.src) {
            // Don't load external scripts - we'll handle the functionality in the main app
            console.log('Skipping external script:', oldScript.src);
          } else {
            // Rewrite the script content to work in our context
            const scriptContent = oldScript.textContent
              .replace(/document\.addEventListener\('DOMContentLoaded'/g, 'function initModule')
              .replace(/window\.location\.href/g, 'parent.window.location.href');
            
            try {
              // Create a function with the module's code
              const moduleInit = new Function('accessToken', 'REGION', `
                ${scriptContent}
                return initModule ? initModule() : null;
              `);
              
              // Execute the module initialization
              moduleInit(accessToken, REGION);
            } catch (e) {
              console.error('Error executing module script:', e);
            }
          }
        });
        
        initialized[name] = true;
        
      } catch (err) {
        tabContent.innerHTML = `
          <div class="error-message">
            <h3>Error loading module</h3>
            <p>${err.message}</p>
            <button onclick="loadRepo('${name}')">Retry</button>
          </div>
        `;
        console.error(`Error loading ${name}:`, err);
      }
    }

    // Shared API functions that modules can use
    async function fetchAllPages(url) {
      let allItems = [];
      let pageNumber = 1;
      let hasMorePages = true;
      
      while (hasMorePages) {
        const response = await fetch(`${url}${url.includes('?') ? '&' : '?'}pageNumber=${pageNumber}&pageSize=100`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`Error fetching data: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.entities) {
          allItems = allItems.concat(data.entities);
        } else if (Array.isArray(data)) {
          allItems = allItems.concat(data);
        }
        
        if (data.pageCount && data.pageCount > pageNumber) {
          pageNumber++;
        } else {
          hasMorePages = false;
        }
      }
      
      return allItems;
    }

    function showStatusMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = message;
        element.className = `status-message ${type}`;
        element.style.display = 'block';
      }
    }
  </script>
</body>
</html>
