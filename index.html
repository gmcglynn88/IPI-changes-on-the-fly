<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Change Maker by IPI</title>
  <link href="https://fonts.googleapis.com/css2?family=Aptos:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #63AB8F;
      --primary-dark: #549e7a;
      --header-bg: #63AB8F;
      --text-dark: #2c3e50;
      --text-medium: #555;
      --text-light: #777;
      --border-color: #ddd;
      --light-bg: #f5f7fa;
      --card-bg: #f9f9f9;
      --error-color: #dc3545;
      --success-color: #28a745;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Aptos', Arial, sans-serif;
      background-color: var(--light-bg);
      color: var(--text-dark);
      line-height: 1.6;
      display: flex; flex-direction: column; min-height: 100vh;
    }
    header {
      background-color: var(--header-bg);
      color: white;
      padding: 15px 30px;
      display: flex; align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: fixed; width: 100%; top: 0; z-index: 100;
    }
    .header-content {
      display: flex; align-items: center; justify-content: space-between;
      width: 100%; padding: 0 30px;
    }
    .logo img { height:40px; margin-left:20px; }
    .app-container {
      display:flex; flex:1; margin-top:70px;
      max-width:1400px; width:100%; margin:0 auto;
    }
    .sidebar {
      width:250px; background:white;
      box-shadow:2px 0 10px rgba(0,0,0,0.05);
      padding:20px 0; display:flex; flex-direction:column;
      position:fixed; height:calc(100vh-70px);
      overflow-y:auto; left:0;
    }
    .sidebar-nav { display:flex; flex-direction:column; width:100%; }
    .sidebar button {
      background:transparent; border:none;
      padding:12px 25px; text-align:left;
      cursor:pointer; font-size:15px;
      color:var(--text-medium); width:100%;
      transition:all .3s; border-left:3px solid transparent;
      display:flex; justify-content:flex-end;
      white-space:nowrap;
    }
    .sidebar button:hover {
      background:rgba(99,171,143,0.1);
      color:var(--text-dark);
    }
    .sidebar button.active {
      background:rgba(99,171,143,0.1);
      color:var(--primary-color);
      border-left:3px solid var(--primary-color);
      font-weight:500;
    }
    .sidebar button i { margin-right:10px; width:20px; text-align:center; }
    .content-area {
      flex:1; padding:30px;
      margin-left:250px; width:calc(100%-250px);
    }
    .tab-content-container {
      width:100%; max-width:16400px; margin:0 auto;
    }
    .tabcontent { display:none; width:100%; }
    .tabcontent.active { display:block; }
    .app-window {
      background:white; border-radius:8px;
      box-shadow:0 2px 15px rgba(0,0,0,0.05);
      padding:30px; width:100%;
    }
    .form-section { margin-bottom:30px; }
    .form-section h2 {
      color:var(--text-dark); font-size:20px;
      font-weight:500; margin-bottom:20px;
      padding-bottom:8px; border-bottom:2px solid var(--primary-color);
      display:inline-block;
    }
    .form-row {
      display:flex; flex-wrap:wrap; gap:25px;
      margin-bottom:20px;
    }
    .form-group { flex:1; min-width:300px; }
    label {
      display:block; font-weight:500;
      color:var(--text-medium); margin-bottom:8px;
    }
    input, select {
      width:100%; padding:12px 15px;
      border:1px solid var(--border-color);
      border-radius:6px; font-size:15px;
      transition:all .3s;
    }
    input:focus, select:focus {
      outline:none; border-color:var(--primary-color);
      box-shadow:0 0 0 3px rgba(99,171,143,0.2);
    }
    button {
      background:var(--primary-color);
      color:white; border:none; border-radius:6px;
      padding:12px 20px; font-size:15px;
      font-weight:500; cursor:pointer;
      transition:all .3s; display:inline-flex;
      align-items:center; justify-content:center;
    }
    button:hover {
      background:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
    }
    .status-message {
      margin-top:20px; padding:12px 15px;
      border-radius:6px; border-left:4px solid transparent;
    }
    .info { color:var(--info-color); background:rgba(23,162,184,0.1); border-left-color:var(--info-color); }
    .success { color:var(--success-color); background:rgba(40,167,69,0.1); border-left-color:var(--success-color); }
    .error { color:var(--error-color); background:rgba(220,53,69,0.1); border-left-color:var(--error-color); }
    .warning { color:var(--warning-color); background:rgba(255,193,7,0.1); border-left-color:var(--warning-color); }
    .results-table {
      width:100%; border-collapse:collapse; margin-top:20px;
    }
    .results-table th, .results-table td {
      padding:12px 15px; text-align:left;
      border-bottom:1px solid var(--border-color);
      white-space:nowrap;
    }
    .results-table th {
      background:var(--primary-color); color:white;
      font-weight:500;
    }
    .results-table tr:hover { background:rgba(99,171,143,0.05); }

    /* Responsive */
    @media(max-width:992px) {
      .app-container { flex-direction:column; }
      .sidebar {
        width:100%; flex-direction:row;
        overflow-x:auto; padding:0;
        position:relative; height:auto; left:auto;
      }
      .sidebar button {
        padding:15px 20px; border-left:none;
        border-bottom:3px solid transparent;
      }
      .sidebar button.active { border-bottom:3px solid var(--primary-color); }
      .content-area { margin-left:0; width:100%; }
    }
    @media(max-width:768px) {
      .content-area { padding:20px; }
      .app-window { padding:20px; }
      .form-row { gap:15px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Change Maker by IPI</h1>
      <div class="logo">
        <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/IPI_Primary%20Identity_Corporate_REVERSED_ECC.png" alt="IPI Logo">
      </div>
    </div>
  </header>

  <div class="app-container">
    <div class="sidebar">
      <div class="sidebar-nav">
        <button class="tablink active" onclick="openTab(event,'wfmManagement')"><i>üìä</i> WFM Management Unit Search</button>
        <button class="tablink" onclick="openTab(event,'externalWork')"><i>‚úâÔ∏è</i> External Work Creation</button>
        <button class="tablink" onclick="openTab(event,'activityCode')"><i>‚öôÔ∏è</i> Activity Code Management</button>
        <button class="tablink" onclick="openTab(event,'bulkSkills')"><i>üîÑ</i> Bulk Skill Changes</button>
        <button class="tablink" onclick="openTab(event,'bulkQueues')"><i>üîÑ</i> Bulk Queue Changes</button>
        <button class="tablink" onclick="openTab(event,'workTeamManagement')"><i>üë•</i> Work Team Management</button>
        <button class="tablink" onclick="openTab(event,'intradayPlan')"><i>üìÖ</i> Intraday Weekly Plan</button>
      </div>
    </div>

    <div class="content-area">
      <div class="tab-content-container">
        <!-- other tabs omitted for brevity... -->

        <!-- Intraday Weekly Plan Tab -->
        <div id="intradayPlan" class="tabcontent">
          <div class="app-window" style="width:100%; max-width:none;">
            <div class="form-section">
              <h2>Intraday Weekly Plan</h2>
              <div id="intradayAuthMessage" class="status-message info">Authenticating with PureCloud...</div>

              <div class="form-row">
                <div class="form-group">
                  <label for="businessUnitSelect">Select Business Unit:</label>
                  <select id="businessUnitSelect" disabled>
                    <option value="">-- Loading Business Units --</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="planningGroup">Select Planning Group:</label>
                  <select id="planningGroup" disabled>
                    <option value="">-- Select Business Unit First --</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="weekSelect">Select Week:</label>
                  <select id="weekSelect" disabled>
                    <option value="">-- Loading Weeks --</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="mediaType">Media Type:</label>
                  <select id="mediaType">
                    <option value="">--All--</option>
                    <option value="Voice">Voice</option>
                    <option value="Message">Message</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="timeFormat">Time Format:</label>
                  <select id="timeFormat">
                    <option value="seconds">Seconds</option>
                    <option value="hms">HH:MM:SS</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="numberPrecision">Number Precision:</label>
                  <select id="numberPrecision">
                    <option value="0">0</option>
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <button id="refreshIntradayData">Refresh Data</button>
              </div>

              <div class="intraday-tabs">
                <div id="dailyTabButton" class="intraday-tab active">Daily Data</div>
                <div id="intervalTabButton" class="intraday-tab">15-min Intervals</div>
              </div>

              <div id="dailyTab" class="intraday-tab-content active">
                <div id="weeklySummary" class="loading">Select a week to view data</div>
                <div id="dailyTableContainer" style="overflow-x:auto;"></div>
              </div>

              <div id="intervalTab" class="intraday-tab-content">
                <div id="intervalTableContainer" class="loading">Select a day to view interval data</div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /.tab-content-container -->
    </div><!-- /.content-area -->
  </div><!-- /.app-container -->

  <script>
    // -- all your existing JS up through other tabs --

    // Intraday Plan code you provided, replacing the old:
    const REGION = 'mypurecloud.ie';
    let accessToken = null;
    let intradayConfig = { timeFormat: 'seconds', precision: 1 };
    let intradayState = { planningGroupName: '', weekData: [] };

    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      accessToken = params.get('access_token') || sessionStorage.getItem('purecloud_token');
      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        initIntradayPlan();
      } else {
        window.location.href = `https://login.${REGION}/oauth/authorize?client_id=4652c8b5-9117-43c6-8e54-77eeb38aebb8&response_type=token&redirect_uri=${encodeURIComponent(location.href)}`;
      }
    });

    function initIntradayPlan() {
      const authMsg = document.getElementById('intradayAuthMessage');
      authMsg.textContent = 'Authenticated successfully!';
      authMsg.className = 'status-message success';
      setTimeout(() => authMsg.style.display='none', 2000);

      document.getElementById('businessUnitSelect').addEventListener('change', onBusinessUnitChange);
      document.getElementById('planningGroup').addEventListener('change', onPlanningGroupChange);
      document.getElementById('weekSelect').addEventListener('change', onWeekSelectChange);
      document.getElementById('mediaType').addEventListener('change', renderDailyTable);
      document.getElementById('dailyTabButton').addEventListener('click', () => setActiveTab('daily'));
      document.getElementById('intervalTabButton').addEventListener('click', () => setActiveTab('interval'));
      document.getElementById('timeFormat').addEventListener('change', () => { intradayConfig.timeFormat = event.target.value; renderAllData(); });
      document.getElementById('numberPrecision').addEventListener('change', () => { intradayConfig.precision = +event.target.value; renderAllData(); });
      document.getElementById('refreshIntradayData').addEventListener('click', () => {
        const w = document.getElementById('weekSelect').value;
        if (w) fetchDataForWeek(w);
      });

      fetchBusinessUnits();
      populateWeekSelect();
    }

    async function fetchBusinessUnits() {
      try {
        const res = await fetch(`https://api.${REGION}/api/v2/workforcemanagement/businessunits`, {
          headers:{ 'Authorization':'Bearer '+accessToken }
        });
        const { entities } = await res.json();
        const sel = document.getElementById('businessUnitSelect');
        sel.innerHTML = '<option value="">-- Select Business Unit --</option>';
        entities.forEach(bu => {
          sel.insertAdjacentHTML('beforeend', `<option value="${bu.id}">${bu.name}</option>`);
        });
        sel.disabled = false;
      } catch (e) {
        document.getElementById('businessUnitSelect').innerHTML = '<option>Error loading business units</option>';
      }
    }

    async function fetchPlanningGroups(buId) {
      const sel = document.getElementById('planningGroup');
      sel.innerHTML = '<option>Loading...</option>'; sel.disabled=true;
      try {
        const res = await fetch(`https://api.${REGION}/api/v2/workforcemanagement/businessunits/${buId}/planninggroups`, {
          headers:{ 'Authorization':'Bearer '+accessToken }
        });
        const { entities } = await res.json();
        sel.innerHTML = '<option value="">-- Select Planning Group --</option>';
        entities.forEach(pg => sel.insertAdjacentHTML('beforeend', `<option value="${pg.id}">${pg.name}</option>`));
        sel.disabled = false;
      } catch {
        sel.innerHTML = '<option>Error loading groups</option>';
      }
    }

    function onBusinessUnitChange(e) {
      const bu = e.target.value;
      if (bu) fetchPlanningGroups(bu);
      else {
        const sel = document.getElementById('planningGroup');
        sel.innerHTML = '<option value="">-- Select BU First --</option>';
        sel.disabled = true;
      }
    }

    function onPlanningGroupChange(e) {
      intradayState.planningGroupName = e.target.selectedOptions[0].text;
      document.getElementById('weekSelect').disabled = !e.target.value;
    }

    function populateWeekSelect() {
      const sel = document.getElementById('weekSelect');
      sel.innerHTML = '<option value="">-- Select Week --</option>';
      const today = new Date(), day=today.getDay(), diff = today.getDate() - day + (day?1:-6);
      const mon = new Date(today.setDate(diff));
      for(let w=0;w<52;w++){
        const start=new Date(mon), end=new Date(mon);
        start.setDate(mon.getDate()+7*w);
        end.setDate(start.getDate()+6);
        const ukStart = start.toLocaleDateString('en-GB'), ukEnd=end.toLocaleDateString('en-GB');
        const iso=start.toISOString().split('T')[0];
        sel.insertAdjacentHTML('beforeend',
          `<option value="${iso}"${w===0?' selected':''}>Week ${ukStart} - ${ukEnd}</option>`
        );
      }
      sel.disabled=false;
    }

    function setActiveTab(tab) {
      document.getElementById('dailyTab').classList.toggle('active', tab==='daily');
      document.getElementById('intervalTab').classList.toggle('active', tab==='interval');
      document.getElementById('dailyTabButton').classList.toggle('active', tab==='daily');
      document.getElementById('intervalTabButton').classList.toggle('active', tab==='interval');
    }

    async function fetchIntradayData(date) {
      const bu = document.getElementById('businessUnitSelect').value;
      const pg = document.getElementById('planningGroup').value;
      if(!bu) return { date, data:null, error:'No BU selected' };
      const res = await fetch(`https://api.${REGION}/api/v2/workforcemanagement/businessunits/${bu}/intraday`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+accessToken},
        body:JSON.stringify({
          businessUnitDate:date,
          categories:["ForecastData","PerformancePredictionData","ScheduleData"],
          intervalLengthMinutes:15,
          planningGroupIds: pg?[pg]:null
        })
      });
      if(!res.ok){
        if(res.status===404) return {date,data:null,error:'No data for '+date};
        throw new Error(res.statusText);
      }
      return { date, data: await res.json() };
    }

    async function fetchDataForWeek(start) {
      const dates = [];
      const [y,m,d]=start.split('-').map(Number);
      const base=new Date(y,m-1,d);
      for(let i=0;i<7;i++){
        const dt=new Date(base); dt.setDate(base.getDate()+i);
        const raw = dt.toISOString().split('T')[0];
        const uk = dt.toLocaleDateString('en-GB');
        dates.push({raw,uk});
      }
      intradayState.weekData = await Promise.all(
        dates.map(o => fetchIntradayData(o.raw).then(r=>({...r,uk:o.uk})))
      );
      renderAllData();
    }

    function getDayOfWeek(uk){
      const [d,m,y]=uk.split('/').map(Number);
      const dt=new Date(y,m-1,d);
      return dt.toLocaleDateString('en-US',{weekday:'long'});
    }
    function formatTime(s){
      s=Math.round(s||0);
      if(intradayConfig.timeFormat==='hms'){
        const h=Math.floor(s/3600), mm=Math.floor((s%3600)/60), ss=s%60;
        return h?`${h}:${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`:`${mm}:${ss.toString().padStart(2,'0')}`;
      }
      return s+'s';
    }
    function formatHours(s){ return ((s||0)/3600).toFixed(intradayConfig.precision)+'h'; }
    function formatNumber(n){ return n.toFixed(intradayConfig.precision); }

    function renderAllData(){
      renderDailyTable();
      if(document.getElementById('intervalTab').classList.contains('active')){
        const h3 = document.querySelector('#intervalTableContainer h3');
        if(h3){
          const m=h3.textContent.match(/\((Voice|Message)\)/);
          const date = h3.textContent.match(/for (\d{2}\/\d{2}\/\d{4})/);
          if(m && date){
            const day = intradayState.weekData.find(d=>d.uk===date[1]);
            if(day) render15MinTable(day,m[1]);
          }
        }
      }
    }

    function renderDailyTable(){
      const filter = document.getElementById('mediaType').value;
      let html=`<table class="results-table"><thead><tr>
        <th>Date</th><th>Day</th><th>Planning Group</th><th>Media Type</th>
        <th>Forecast Offered</th><th>Forecast AHT</th><th>Scheduled Time</th>
        <th>Service Level</th><th>ASA</th><th>Occupancy</th><th>Action</th>
      </tr></thead><tbody>`;
      const totals={off:0,aht:0,sch:0,sl:0,asa:0,occ:0,c:0};
      intradayState.weekData.forEach(day=>{
        if(!day.data||!day.data.result){
          html+=`<tr><td>${day.uk}</td><td>${getDayOfWeek(day.uk)}</td>
            <td colspan="9" class="no-data">${day.error||'No data'}</td></tr>`;
          return;
        }
        day.data.result.intradayDataGroupings.forEach(g=>{
          if(filter&&g.mediaType!==filter) return;
          const o=g.forecastDataSummary?.offered||0;
          const a=g.forecastDataSummary?.averageHandleTimeSeconds||0;
          const s=g.scheduleDataSummary?.onQueueTimeSeconds||0;
          const sl=g.performancePredictionDataSummary?.serviceLevelPercent||0;
          const asa=g.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds||0;
          const occ=g.performancePredictionDataSummary?.occupancyPercent||0;
          totals.off+=o; totals.aht+=a; totals.sch+=s;
          totals.sl+=sl; totals.asa+=asa; totals.occ+=occ; totals.c++;
          html+=`<tr><td>${day.uk}</td><td>${getDayOfWeek(day.uk)}</td>
            <td>${intradayState.planningGroupName}</td><td>${g.mediaType}</td>
            <td>${Math.round(o)}</td><td>${formatTime(a)}</td>
            <td>${formatHours(s)}</td><td>${formatNumber(sl)}%</td>
            <td>${formatTime(asa)}</td><td>${formatNumber(occ)}%</td>
            <td><button onclick='show15MinDetails(${JSON.stringify(day)}, "${g.mediaType}")'>
              View Details</button></td></tr>`;
        });
      });
      const avgAHT=totals.c?totals.aht/totals.c:0;
      const avgSL=totals.c?totals.sl/totals.c:0;
      const avgASA=totals.c?totals.asa/totals.c:0;
      const avgOcc=totals.c?totals.occ/totals.c:0;
      html+=`</tbody></table>
        <table class="intraday-summary-table"><thead><tr>
        <th>Summary</th><th>Forecast Offered</th><th>Avg AHT</th>
        <th>Total Scheduled</th><th>Avg SL</th><th>Avg ASA</th><th>Avg Occupancy</th>
      </tr></thead><tbody><tr>
        <td>Weekly Totals/Averages</td>
        <td>${Math.round(totals.off)}</td>
        <td>${formatTime(avgAHT)}</td>
        <td>${formatHours(totals.sch)}</td>
        <td>${formatNumber(avgSL)}%</td>
        <td>${formatTime(avgASA)}</td>
        <td>${formatNumber(avgOcc)}%</td>
      </tr></tbody></table>`;
      document.getElementById('weeklySummary').innerHTML = html;
      document.getElementById('weeklySummary').className = '';
      document.getElementById('dailyTableContainer').innerHTML = html;
    }

    function render15MinTable(day, mediaType){
      let html = `<h3>15-min Intervals for ${day.uk} (${mediaType})</h3>
        <div style="overflow-x:auto;"><table class="results-table">
        <thead><tr><th>Time</th><th>Forecast Offered</th><th>Forecast AHT</th>
        <th>Scheduled Time</th><th>Service Level</th><th>ASA</th><th>Occupancy</th>
        </tr></thead><tbody>`;
      const g = day.data?.result?.intradayDataGroupings.find(x=>x.mediaType===mediaType);
      if(!g){
        html+='<tr><td colspan="7" class="no-data">No data</td></tr>';
      } else {
        const start=new Date(day.data.result.startDate);
        for(let i=0;i<96;i++){
          const t=new Date(start); t.setMinutes(start.getMinutes()+15*i);
          const ts = t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          const f = g.forecastDataPerInterval?.[i]||{};
          const s = g.scheduleDataPerInterval?.[i]||{};
          const p = g.performancePredictionDataPerInterval?.[i]||{};
          html+=`<tr><td>${ts}</td>
            <td>${Math.round(f.offered||0)}</td>
            <td>${formatTime(f.averageHandleTimeSeconds||0)}</td>
            <td>${formatHours(s.onQueueTimeSeconds||0)}</td>
            <td>${formatNumber(p.serviceLevelPercent||0)}%</td>
            <td>${formatTime(p.averageSpeedOfAnswerSeconds||0)}</td>
            <td>${formatNumber(p.occupancyPercent||0)}%</td>
          </tr>`;
        }
      }
      html += '</tbody></table></div>';
      document.getElementById('intervalTableContainer').innerHTML = html;
      document.getElementById('intervalTableContainer').className = '';
    }

    function show15MinDetails(day, mediaType){
      setActiveTab('interval');
      render15MinTable(day, mediaType);
    }

    // Tab switch utility
    function openTab(evt, name){
      Array.from(document.querySelectorAll('.tablink')).forEach(btn=>btn.classList.remove('active'));
      evt.currentTarget.classList.add('active');
      Array.from(document.querySelectorAll('.tabcontent')).forEach(tc=>tc.classList.remove('active'));
      document.getElementById(name).classList.add('active');
    }
  </script>
</body>
</html>
