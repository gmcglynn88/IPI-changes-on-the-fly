<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Change Maker by IPI</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Aptos:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #63ab8f;
      --primary-dark: #549e7a;
      --header-bg: #63ab8f;
      --text-dark: #2c3e50;
      --text-medium: #555;
      --text-light: #777;
      --border-color: #ddd;
      --light-bg: #f5f7fa;
      --card-bg: #f9f9f9;
      --error-color: #dc3545;
      --success-color: #28a745;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Aptos', Arial, sans-serif;
      background: var(--light-bg);
      color: var(--text-dark);
      display: flex; flex-direction: column; min-height: 100vh;
    }
    header {
      background: var(--header-bg); color: #fff;
      padding: 15px 30px; position: fixed; top: 0; width: 100%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100;
    }
    .header-content { display:flex; justify-content:space-between; align-items:center; }
    .logo img { height: 40px; }
    .app-container { display:flex; margin-top:70px; flex:1; max-width:1400px; margin:0 auto; }
    .sidebar {
      width:250px; background:#fff; box-shadow:2px 0 10px rgba(0,0,0,0.05);
      position:fixed; top:70px; bottom:0; overflow-y:auto; padding:20px 0;
    }
    .sidebar-nav button {
      width:100%; border:none; background:transparent;
      padding:12px 25px; text-align:left; font-size:15px;
      color:var(--text-medium); cursor:pointer;
      transition:all .3s; border-left:3px solid transparent;
      display:flex; justify-content:flex-end; white-space:nowrap;
    }
    .sidebar-nav button.active {
      background:rgba(99,171,143,0.1);
      color:var(--primary-color); border-left-color:var(--primary-color);
      font-weight:500;
    }
    .sidebar-nav button:hover { background:rgba(99,171,143,0.1); color:var(--text-dark); }
    .sidebar-nav i { margin-right:10px; width:20px; text-align:center; }
    .content-area {
      margin-left:250px; padding:30px; flex:1; overflow:auto;
    }
    .tabcontent { display:none; }
    .tabcontent.active { display:block; }
    .app-window {
      background:#fff; border-radius:8px; box-shadow:0 2px 15px rgba(0,0,0,0.05);
      padding:30px;
    }
    .form-section h2 {
      font-size:20px; font-weight:500; margin-bottom:20px;
      border-bottom:2px solid var(--primary-color); display:inline-block;
    }
    .form-row { display:flex; flex-wrap:wrap; gap:25px; margin-bottom:20px; }
    .form-group { flex:1; min-width:300px; }
    label { display:block; margin-bottom:8px; color:var(--text-medium); font-weight:500; }
    input, select, button {
      font-size:15px; border-radius:6px; transition:all .3s;
    }
    input, select {
      padding:12px; border:1px solid var(--border-color); width:100%;
    }
    input:focus, select:focus {
      outline:none; border-color:var(--primary-color);
      box-shadow:0 0 0 3px rgba(99,171,143,0.2);
    }
    button {
      padding:12px 20px; border:none;
      background:var(--primary-color); color:#fff; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
    }
    button:hover {
      background:var(--primary-dark); transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
    }
    .status-message {
      margin-top:20px; padding:12px 15px; border-radius:6px;
      border-left:4px solid transparent;
    }
    .info { background:rgba(23,162,184,0.1); color:var(--info-color); border-left-color:var(--info-color); }
    .success { background:rgba(40,167,69,0.1); color:var(--success-color); border-left-color:var(--success-color); }
    .error { background:rgba(220,53,69,0.1); color:var(--error-color); border-left-color:var(--error-color); }
    .warning { background:rgba(255,193,7,0.1); color:var(--warning-color); border-left-color:var(--warning-color); }
    .intraday-tabs { display:flex; border-bottom:1px solid var(--border-color); margin-bottom:20px; }
    .intraday-tab {
      padding:10px 20px; cursor:pointer; background:rgba(99,171,143,0.1);
      border:1px solid transparent; border-bottom:none; border-radius:4px 4px 0 0;
      margin-right:5px; color:var(--text-medium);
    }
    .intraday-tab.active {
      background:#fff; color:var(--primary-color);
      border-color:var(--border-color); border-bottom:1px solid #fff;
      font-weight:500; margin-bottom:-1px;
    }
    .intraday-tab-content { display:none; padding:20px 0; }
    .intraday-tab-content.active { display:block; }
    .results-table, .intraday-summary-table {
      width:100%; border-collapse:collapse; margin-top:20px;
    }
    .results-table th, .results-table td,
    .intraday-summary-table th, .intraday-summary-table td {
      padding:12px; border-bottom:1px solid var(--border-color); text-align:left;
      white-space:nowrap;
    }
    .results-table th, .intraday-summary-table th {
      background:var(--primary-color); color:#fff; font-weight:500;
    }
    .no-data, .loading { color:var(--text-light); font-style:italic; }
    @media(max-width:992px){
      .sidebar{position:relative;width:100%;flex-direction:row;height:auto;top:0;}
      .content-area{margin-left:0;}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Change Maker by IPI</h1>
      <div class="logo">
        <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/IPI_Primary%20Identity_Corporate_REVERSED_ECC.png" alt="IPI Logo"/>
      </div>
    </div>
  </header>

  <div class="app-container">
    <nav class="sidebar">
      <div class="sidebar-nav">
        <button class="tablink active" onclick="openTab(event,'intradayPlan')"><i>ðŸ“…</i> Intraday Weekly Plan</button>
        <!-- other tabs... -->
      </div>
    </nav>

    <main class="content-area">
      <div id="intradayPlan" class="tabcontent active">
        <div class="app-window">
          <div class="form-section">
            <h2>Intraday Weekly Plan</h2>
            <div id="intradayAuthMessage" class="status-message info">Authenticating with PureCloud...</div>

            <!-- Controls -->
            <div class="form-row">
              <div class="form-group">
                <label for="businessUnitSelect">Business Unit</label>
                <select id="businessUnitSelect" disabled>
                  <option>-- Loading --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="planningGroup">Planning Group</label>
                <select id="planningGroup" disabled>
                  <option>-- Select BU First --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="weekSelect">Week</label>
                <select id="weekSelect" disabled>
                  <option>-- Loading Weeks --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="mediaType">Media Type</label>
                <select id="mediaType">
                  <option value="">--All--</option>
                  <option>Voice</option>
                  <option>Message</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="timeFormat">Time Format</label>
                <select id="timeFormat">
                  <option value="seconds">Seconds</option>
                  <option value="hms">HH:MM:SS</option>
                </select>
              </div>
              <div class="form-group">
                <label for="numberPrecision">Precision</label>
                <select id="numberPrecision">
                  <option>0</option>
                  <option selected>1</option>
                  <option>2</option>
                  <option>3</option>
                </select>
              </div>
              <div class="form-group" style="align-self:flex-end">
                <button id="refreshIntradayData">Refresh Data</button>
              </div>
            </div>

            <!-- Sub-tabs -->
            <div class="intraday-tabs">
              <div id="dailyTabButton" class="intraday-tab active">Daily Data</div>
              <div id="intervalTabButton" class="intraday-tab">15-min Intervals</div>
              <div id="continuousTabButton" class="intraday-tab">Continuous</div>
            </div>

            <!-- Daily Data -->
            <div id="dailyTab" class="intraday-tab-content active">
              <div id="weeklySummary" class="loading">Select a week to view data</div>
              <div id="dailyTableContainer" style="overflow-x:auto;"></div>
            </div>

            <!-- 15-min Intervals + Distribution -->
            <div id="intervalTab" class="intraday-tab-content">
              <div id="intervalTableContainer" class="loading">Select a day to view interval data</div>
              <canvas id="distChart" style="max-height:300px; margin-top:20px;"></canvas>
            </div>

            <!-- Continuous view: daily totals plus trends -->
            <div id="continuousTab" class="intraday-tab-content">
              <h3>Daily Totals This Week</h3>
              <table class="intraday-summary-table" id="continuousTable"></table>
              <h3 style="margin-top:30px;">Short-Term Trend (Week)</h3>
              <canvas id="shortTermChart" style="max-height:200px;"></canvas>
              <h3 style="margin-top:30px;">Long-Term Trend (Last 4 Weeks)</h3>
              <canvas id="longTermChart" style="max-height:200px;"></canvas>
            </div>
          </div>
        </div>
      </div>
      <!-- other tabcontents unchanged... -->
    </main>
  </div>

  <script>
    // Paste here all your existing â€¹Global Configâ€º, auth, tab management,
    // fetchIntradayData, fetchDataForWeek, renderDailyTable, render15MinTable, etc.
    // â€¦then add/replace the following at the end:

    // --- Intraday JS enhancements ---
    function setActiveTab(tab) {
      ['daily','interval','continuous'].forEach(t=>{
        document.getElementById(t+'Tab').classList.toggle('active', t===tab);
        document.getElementById(t+'TabButton').classList.toggle('active', t===tab);
      });
    }
    document.getElementById('dailyTabButton').onclick   = ()=>setActiveTab('daily');
    document.getElementById('intervalTabButton').onclick= ()=>setActiveTab('interval');
    document.getElementById('continuousTabButton').onclick=()=>setActiveTab('continuous');

    // After fetchDataForWeek completes:
    function renderContinuous() {
      // build daily totals table
      let html = '<thead><tr><th>Date</th><th>Offered</th><th>AHT</th><th>Scheduled</th><th>SL%</th><th>ASA</th><th>Occupancy%</th></tr></thead><tbody>';
      intradayState.weekData.forEach(day=>{
        if(!day.data?.result) return;
        day.data.result.intradayDataGroupings.forEach(g=>{
          const o=g.forecastDataSummary?.offered||0;
          const a=g.forecastDataSummary?.averageHandleTimeSeconds||0;
          const s=g.scheduleDataSummary?.onQueueTimeSeconds||0;
          const sl=g.performancePredictionDataSummary?.serviceLevelPercent||0;
          const asa=g.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds||0;
          const occ=g.performancePredictionDataSummary?.occupancyPercent||0;
          html+=`<tr>
            <td>${day.uk}</td>
            <td>${o}</td>
            <td>${formatTime(a)}</td>
            <td>${formatHours(s)}</td>
            <td>${sl.toFixed(intradayConfig.precision)}%</td>
            <td>${formatTime(asa)}</td>
            <td>${occ.toFixed(intradayConfig.precision)}%</td>
          </tr>`;
        });
      });
      html+='</tbody>';
      document.getElementById('continuousTable').innerHTML=html;

      // build short-term line chart
      const labels = intradayState.weekData.map(d=>d.uk);
      const seriesOff = intradayState.weekData.map(d=>
        d.data?.result?.intradayDataGroupings.reduce((sum,g)=>sum+(g.forecastDataSummary?.offered||0),0) || 0
      );
      new Chart(document.getElementById('shortTermChart'), {
        type:'line',
        data:{ labels, datasets:[{
          label:'Forecast Offered', data:seriesOff, fill:false, tension:0.3
        }]},
        options:{ responsive:true, plugins:{ legend:{ display:false } } }
      });

      // long-term: simulate last-4-weeks by duplicating current week labels with offset
      const ltLabels=[], ltData=[];
      for(let w=-3;w<=0;w++){
        intradayState.weekData.forEach((d,i)=>{
          const dt=new Date(d.raw); dt.setDate(dt.getDate() + 7*w);
          ltLabels.push(dt.toLocaleDateString('en-GB'));
          ltData.push(seriesOff[i]);
        });
      }
      new Chart(document.getElementById('longTermChart'), {
        type:'line',
        data:{ labels:ltLabels, datasets:[{
          label:'Offered (4wk)', data:ltData, fill:false, tension:0.3
        }]},
        options:{ responsive:true, plugins:{ legend:{ display:false }}
      }});
    }

    // in your renderAllData(), at end call renderContinuous():
    // ...
    // renderContinuous();

    // Distribution chart in 15-min:
    function renderDistribution(day, mediaType) {
      const grouping = day.data.result.intradayDataGroupings.find(g=>g.mediaType===mediaType);
      if(!grouping) return;
      const labels = [], data=[];
      const start=new Date(day.data.result.startDate);
      for(let i=0;i<96;i++){
        const t=new Date(start); t.setMinutes(t.getMinutes()+15*i);
        labels.push(t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
        data.push(grouping.forecastDataPerInterval?.[i]?.offered||0);
      }
      new Chart(document.getElementById('distChart'), {
        type:'bar',
        data:{ labels, datasets:[{
          label:'Offered per 15m', data, backgroundColor:'rgba(99,171,143,0.6)'
        }]},
        options:{ responsive:true, scales:{ x:{ display:false }}, plugins:{ legend:{ display:false }} }
      });
    }

    // in show15MinDetails(), after render15MinTable(...) add:
    // renderDistribution(day, mediaType);

  </script>
</body>
</html>
